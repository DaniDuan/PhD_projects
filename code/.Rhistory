gr_gompertz = gompertz_model(t, summary(model_fit_gompertz)$coefficients[1],
summary(model_fit_gompertz)$coefficients[2],
summary(model_fit_gompertz)$coefficients[3],
summary(model_fit_gompertz)$coefficients[4])
lines(t, gr_gompertz, col = "blue")
}else{r_value_gompertz = NaN; AIC_value_gompertz = NaN}
# fitting logistic
model_fit_logistic = try(nlsLM(N~logistic_model(t = time, r_max, K, N_0), sub,
start = list(r_max=r_max_start, N_0 = N_0_start, K = K_start),
control = list(maxiter = 500)),silent = T)
if(class(model_fit_logistic) != "try-error"){
r_value_logistic = round(summary(model_fit_logistic)$coefficients[1], 4)
AIC_value_logistic = round(AIC(model_fit_logistic),3)
gr_logistic = logistic_model(t, summary(model_fit_logistic)$coefficients[1],
summary(model_fit_logistic)$coefficients[3],
summary(model_fit_logistic)$coefficients[2])
lines(t, gr_logistic, col = "darkorange")
}else{r_value_logistic = NaN; AIC_value_logistic = NaN}
# }
if(is.nan(AIC_value_gompertz) | AIC_value_logistic - AIC_value_gompertz < -3 & r_value_logistic != 0 |r_value_gompertz > 1.5){
Model = "Logistic"; r_value = r_value_logistic; AIC_value = AIC_value_logistic
}else{Model = "Gompertz"; r_value = r_value_gompertz; AIC_value = AIC_value_gompertz}
text(60, ((max(subset[,s], na.rm = T)+min(subset[,s], na.rm = T))/2),
paste("r=",r_value,"\nModel= ", Model, sep=""))
legend("topleft", c("Gompertz", "Logistic"), col = c("blue", "darkorange"), lty = 1)
# }
# graphics.off()
r = c(r, r_value)
aic = c(aic, AIC_value)
}
all_r = rbind(all_r, r)
all_AIC = rbind(all_AIC, aic)
}
}
# S18, 12C
graphics.off()
# x = all_r # backup
# all_r = x
all_r[all_r==0] = NaN
# all_r[all_AIC>15] = NaN
all_r[all_r>1.5] = NaN
names(all_r) = sp
all_r$temp = sort(rep(temp,6))
all_r$Rep = rep(1:6,6)
all_r$W02[35] = NaN # value too much higher than all other 5 replicates
all_r$W02[23] = NaN # value too much lower than all other 5 replicates
all_r$S18[all_r$S18<0.1] = NaN # Irregular low value comparing with the point plot
mean = data.frame()
sd = data.frame()
for(i in temp){
subset = subset(all_r, temp == i)
mean = rbind(mean, colMeans(subset[,1:3], na.rm = T))
sd = rbind(sd, apply(subset[,1:3], 2, sd, na.rm = T))
}
names(mean) = sp
names(sd) = sp
mean$temp = temp
sd$temp = temp
color = c("darkgreen","blue", "darkorange")
pdf("../results/TPC/Temperature_performances.pdf")
# png(filename = "../results/TPC/Temperature_performances.png", width = 480, height = 480)
plot(1, type="n", xlab="Temperature", ylab = "Growth rate", main = "Temperature Performance",
xlim = c(temp[1],temp[length(temp)]),
ylim =c(min((mean[,1:3]-sd[,1:3]), na.rm = T),
max((mean[,1:3]+sd[,1:3]), na.rm = T)))
for(i in 1:3){
lines(temp,mean[,i], type="b", pch = 1, col = color[i])
suppressWarnings(arrows(x0=temp, y0=mean[,i]-sd[,i], x1=temp, y1=mean[,i]+sd[,i],
code=3, angle=90, lwd=0.6, length = 0.05, col = color[i]))
}
legend("topleft", sp, cex = 1, col = color, pch = 1, lwd = 1)
graphics.off()
################################### Fitting with all reps ###################################
library(rTPC)
library(boot)
library(car)
mod = 'sharpeschoolhigh_1981'
# all_rlog = data.frame(log(all_r[,1:3]), all_r$temp)
# names(all_rlog) = names(all_r[1:4])
# all_rlog$temp = all_rlog$temp+273.15
k = 8.61*10^(-5)
initials = data.frame()
for(s in 1:length(sp)){
# if(length(subset[,s][!is.na(subset[,s])]) > 4){
lnB0_start = min(all_r[1:6,s][!is.na(all_r[,s])], na.rm = T)
Th_v = all_r$temp[all_r[,s] == max(all_r[,s], na.rm = T)] #subset[,4][subset[,s] == max(subset[,s], na.rm = T)]
Th_start = Th_v[!is.na(Th_v)]
## Fitting lnB ~ -1/k*(1/T-1/283.15) as linear model (Arrhenius)
## intercept = lnB0, slope = Ea
kkt = -1/(k*all_r$temp)+1/(285.15*k) # -1/k*(1/T-1/283.15)
befdeact = all_r[,s][all_r$temp <= Th_start] # lnB before deactivation
B_befT = kkt[all_r$temp <= Th_start] # -1/k*(1/T-1/283.15) before deactivation
lm_Arr = lm(befdeact~B_befT)
lnB0_start = summary(lm_Arr)$coefficients[1]
Ea_start = summary(lm_Arr)$coefficients[2]
row = data.frame(r_tref = exp(lnB0_start), e = Ea_start, eh = 7, th = Th_start)
initials = rbind(initials, row)
}
temp_plot = seq(10,30,0.1)
est_params = data.frame()
for(s in 1:3){
start_vals = initials[s,]
sub <- data.frame(N = all_r[,s], temp = all_r$temp)
# get limits
low_lims <- get_lower_lims(sub$temp, sub$N, model_name = 'sharpeschoolhigh_1981')
upper_lims <- get_upper_lims(sub$temp, sub$N, model_name = 'sharpeschoolhigh_1981')
fit <- nls_multstart(N~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = sub,
iter = 2000,
start_lower = start_vals - 10,
start_upper = start_vals + 10,
lower = low_lims,
upper = upper_lims,
supp_errors = 'Y')
plot(sub$temp, sub$N, main = sp[s],
ylim = c(min(sub$N, na.rm = T), (max(sub$N, na.rm = T)+0.2)))
out = as.numeric(c(start_vals, summary(fit)$coefficients[1:4], AIC(fit)))
B0 = out[5]; Ea = out[6]; Eh = out[7]; Th = out[8]
B_plot = sharpeschoolhigh_1981(temp = temp_plot, r_tref = B0, e = Ea, eh = Eh, th = Th, tref = 12)
lines(temp_plot, B_plot, col = 'black')
est_params = rbind(est_params, out)
}
names(est_params) = c("lnB0_Arr","Ea_Arr","Eh_Arr", "Th_Arr", "B0", "Ea", "Eh", "Th", "AIC")
est_params$sp = sp
for(s in 1:length(sp)){
B0 = est_params[s,5]; Ea = est_params[s,6]; Eh = est_params[s,7]; Th = est_params[s,8]
if(s == 1){
fit <- nlsLM(S18~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}else if(s == 2){
fit <- nlsLM(W02~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}else{
fit <- nlsLM(W03~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}
# bootresult <-  Boot(fit, method = 'case')
bootresult <- Boot(fit_nlsLM2, method = 'residual')
png(filename = paste("../results/TPC/", sp[s], "_TPC_boot.png", sep = ""), width = 960, height = 960)
hist(bootresult, layout = c(2,2))
graphics.off()
sub <- data.frame(N = all_r[,s], temp = all_r$temp)
d_fit <- nest(sub, data = c(temp, N)) %>%
mutate(sharpeschoolhigh = map(data, ~nlsLM(N~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = .x, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))),
# create new temperature data
new_data = map(data, ~tibble(temp = seq(min(.x$temp), max(.x$temp), length.out = 100))),
# predict over that data,
preds =  map2(sharpeschoolhigh, new_data, ~augment(.x, newdata = .y)))
# unnest predictions
d_preds <- select(d_fit, preds) %>%
unnest(preds)
boot1_preds <- bootresult$t %>%
as.data.frame() %>%
drop_na() %>%
mutate(iter = 1:n()) %>%
group_by_all() %>%
do(data.frame(temp = seq(min(all_r$temp), max(all_r$temp), length.out = 100))) %>%
ungroup() %>%
mutate(pred = sharpeschoolhigh_1981(temp, r_tref, e, eh, th, tref = 12))
# calculate bootstrapped confidence intervals
boot1_conf_preds <- group_by(boot1_preds, temp) %>%
summarise(conf_lower = quantile(pred, 0.025),
conf_upper = quantile(pred, 0.975)) %>%
ungroup()
# # plot bootstrapped CIs
# p1 <- ggplot() +
#   geom_line(aes(temp, .fitted), d_preds, col = 'blue') +
#   geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot1_conf_preds, fill = 'blue', alpha = 0.3) +
#   geom_point(aes(temp, N), sub, size = 2, alpha = 0.5) +
#   theme_bw(base_size = 12) +
#   labs(x = 'Temperature (ºC)',
#        y = 'Growth rate',
#        title = 'Growth rate across temperatures')
# plot bootstrapped predictions
png(filename = paste("../results/TPC/",sp[s], "_TPC.png", sep = ""), width = 960, height = 960)
ggplot() +
geom_line(aes(temp, .fitted), d_preds, col = 'blue') +
geom_line(aes(temp, pred, group = iter), boot1_preds, col = 'blue', alpha = 0.01) +
geom_point(aes(temp, N), sub, size = 2, alpha = 0.5) +
theme_bw(base_size = 12) +
labs(x = 'Temperature (ºC)',
y = 'Growth rate',
title = paste(sp[s],'Growth rate across temperatures'))+
theme(text = element_text(size = 30))
graphics.off()
}
for(s in 1:length(sp)){
B0 = est_params[s,5]; Ea = est_params[s,6]; Eh = est_params[s,7]; Th = est_params[s,8]
if(s == 1){
fit <- nlsLM(S18~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}else if(s == 2){
fit <- nlsLM(W02~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}else{
fit <- nlsLM(W03~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}
# bootresult <-  Boot(fit, method = 'case')
bootresult <- Boot(fit, method = 'residual')
png(filename = paste("../results/TPC/", sp[s], "_TPC_boot.png", sep = ""), width = 960, height = 960)
hist(bootresult, layout = c(2,2))
graphics.off()
sub <- data.frame(N = all_r[,s], temp = all_r$temp)
d_fit <- nest(sub, data = c(temp, N)) %>%
mutate(sharpeschoolhigh = map(data, ~nlsLM(N~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = .x, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))),
# create new temperature data
new_data = map(data, ~tibble(temp = seq(min(.x$temp), max(.x$temp), length.out = 100))),
# predict over that data,
preds =  map2(sharpeschoolhigh, new_data, ~augment(.x, newdata = .y)))
# unnest predictions
d_preds <- select(d_fit, preds) %>%
unnest(preds)
boot1_preds <- bootresult$t %>%
as.data.frame() %>%
drop_na() %>%
mutate(iter = 1:n()) %>%
group_by_all() %>%
do(data.frame(temp = seq(min(all_r$temp), max(all_r$temp), length.out = 100))) %>%
ungroup() %>%
mutate(pred = sharpeschoolhigh_1981(temp, r_tref, e, eh, th, tref = 12))
# calculate bootstrapped confidence intervals
boot1_conf_preds <- group_by(boot1_preds, temp) %>%
summarise(conf_lower = quantile(pred, 0.025),
conf_upper = quantile(pred, 0.975)) %>%
ungroup()
# # plot bootstrapped CIs
# p1 <- ggplot() +
#   geom_line(aes(temp, .fitted), d_preds, col = 'blue') +
#   geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot1_conf_preds, fill = 'blue', alpha = 0.3) +
#   geom_point(aes(temp, N), sub, size = 2, alpha = 0.5) +
#   theme_bw(base_size = 12) +
#   labs(x = 'Temperature (ºC)',
#        y = 'Growth rate',
#        title = 'Growth rate across temperatures')
# plot bootstrapped predictions
png(filename = paste("../results/TPC/",sp[s], "_TPC.png", sep = ""), width = 960, height = 960)
ggplot() +
geom_line(aes(temp, .fitted), d_preds, col = 'blue') +
geom_line(aes(temp, pred, group = iter), boot1_preds, col = 'blue', alpha = 0.01) +
geom_point(aes(temp, N), sub, size = 2, alpha = 0.5) +
theme_bw(base_size = 12) +
labs(x = 'Temperature (ºC)',
y = 'Growth rate',
title = paste(sp[s],'Growth rate across temperatures'))+
theme(text = element_text(size = 30))
graphics.off()
}
for(s in 1:length(sp)){
B0 = est_params[s,5]; Ea = est_params[s,6]; Eh = est_params[s,7]; Th = est_params[s,8]
if(s == 1){
fit <- nlsLM(S18~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}else if(s == 2){
fit <- nlsLM(W02~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}else{
fit <- nlsLM(W03~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = all_r, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))
}
# bootresult <-  Boot(fit, method = 'case')
bootresult <- Boot(fit, method = 'residual')
png(filename = paste("../results/TPC/", sp[s], "_TPC_boot.png", sep = ""), width = 960, height = 960)
hist(bootresult, layout = c(2,2))
graphics.off()
sub <- data.frame(N = all_r[,s], temp = all_r$temp)
d_fit <- nest(sub, data = c(temp, N)) %>%
mutate(sharpeschoolhigh = map(data, ~nlsLM(N~sharpeschoolhigh_1981(temp = temp, r_tref,e,eh,th, tref = 12),
data = .x, start = list(r_tref=B0, e=Ea, eh=Eh, th=Th),
control = list(maxiter = 500))),
# create new temperature data
new_data = map(data, ~tibble(temp = seq(min(.x$temp), max(.x$temp), length.out = 100))),
# predict over that data,
preds =  map2(sharpeschoolhigh, new_data, ~augment(.x, newdata = .y)))
# unnest predictions
d_preds <- select(d_fit, preds) %>%
unnest(preds)
boot1_preds <- bootresult$t %>%
as.data.frame() %>%
drop_na() %>%
mutate(iter = 1:n()) %>%
group_by_all() %>%
do(data.frame(temp = seq(min(all_r$temp), max(all_r$temp), length.out = 100))) %>%
ungroup() %>%
mutate(pred = sharpeschoolhigh_1981(temp, r_tref, e, eh, th, tref = 12))
# calculate bootstrapped confidence intervals
boot1_conf_preds <- group_by(boot1_preds, temp) %>%
summarise(conf_lower = quantile(pred, 0.025),
conf_upper = quantile(pred, 0.975)) %>%
ungroup()
# # plot bootstrapped CIs
# p1 <- ggplot() +
#   geom_line(aes(temp, .fitted), d_preds, col = 'blue') +
#   geom_ribbon(aes(temp, ymin = conf_lower, ymax = conf_upper), boot1_conf_preds, fill = 'blue', alpha = 0.3) +
#   geom_point(aes(temp, N), sub, size = 2, alpha = 0.5) +
#   theme_bw(base_size = 12) +
#   labs(x = 'Temperature (ºC)',
#        y = 'Growth rate',
#        title = 'Growth rate across temperatures')
# plot bootstrapped predictions
png(filename = paste("../results/TPC/",sp[s], "_TPC.png", sep = ""), width = 960, height = 960)
ggplot() +
geom_line(aes(temp, .fitted), d_preds, col = 'blue') +
geom_line(aes(temp, pred, group = iter), boot1_preds, col = 'blue', alpha = 0.01) +
geom_point(aes(temp, N), sub, size = 2, alpha = 0.5) +
theme_bw(base_size = 12) +
labs(x = 'Temperature (ºC)',
y = 'Growth rate',
title = paste(sp[s],'Growth rate across temperatures'))+
theme(text = element_text(size = 30))
graphics.off()
}
source("~/Documents/1yr_project/code/TPC.R")
source("~/Documents/1yr_project/code/TPC.R")
rm(list=ls())
dev.off()
library(minpack.lm)
library(nls.multstart)
library(tidyverse)
library(broom)
library(ggplot2)
d1 = read.csv("../data/TPC/Danica_TPC.csv")
d2 = read.csv("../data/TPC/Danica_TPC_1.csv")
d3 = read.csv("../data/TPC/Danica_TPC_2.csv")
TPC = rbind(d1,d2,d3)
TPC = TPC[!is.na(TPC$X.13),] # removing rows without data
TPC = TPC[,-1] # removing numbering col
TPC = TPC[,-ncol(TPC)] # removing wavelength col
### for timing each relative abundance with OD
TPC = TPC[4:9]
TPC = TPC[-seq(1, nrow(TPC), 8),]
TPC = TPC[-seq(7, nrow(TPC), 7),]
rownames(TPC) = seq(1:nrow(TPC))
TPC[,seq(1,6,2)] = TPC[,seq(1,6,2)] - TPC[,seq(2,6,2)]
TPC = TPC[,-seq(2,6,2)]
temp = c(12, 15, 18, 22, 25, 28)
time = c(0, 10.5, 14.5, 18.5, 22.5, 35, 38.5, 42.5, 46.5, 58.5, 62.5, 66.5, 70.5, 83,
86.5, 90.5, 94.5, 107.5, 119)
sp = c("S18", "W02", "W03")
names(TPC) = sp
TPC$temp = rep(sort(rep(temp, 6)), 19)
TPC$time = sort(rep(time, 36))
TPC$Rep = rep(1:6,(19*6))
mean = data.frame()
sd = data.frame()
for(i in temp){
subset = subset(TPC, temp == i)
for(j in time){
mean = rbind(mean, colMeans(subset[subset$time == j,1:3], na.rm = T))
sd = rbind(sd, apply(subset[subset$time == j,1:3], 2, sd))
}
}
names(mean) = sp
names(sd) = sp
mean$temp = sort(rep(temp, 19))
sd$temp = sort(rep(temp, 19))
mean$time = rep(time, 6)
sd$time = rep(time, 6)
for(i in temp){
m_subset = subset(mean, temp == i)
sd_subset = subset(sd, temp == i)
for(j in 1:length(unique(sp))){
# png(filename = paste(("../results/TPC/TPC_gr_single/"),sp[j],"_",i,".png", sep=""), width = 480, height = 480)
plot(1, type="n", xlab="Hour", ylab = "OD",
main = paste(sp[j],"_", i, "C" ,sep=""),
xlim = c(time[1],time[length(time)]),
ylim =c(min((m_subset[,j]-sd_subset[,j]), na.rm = T),
max(m_subset[,j], na.rm = T)+max(sd_subset[,j],na.rm = T)))
points(time,m_subset[,j], pch = 1)
# lines(time,m_subset[,j], type="b", pch = 1)
arrows(x0=time, y0=m_subset[,j]-sd_subset[,j], x1=time, y1=m_subset[,j]+sd_subset[,j],
code=3, angle=90, lwd=0.6, length = 0.05)
# graphics.off()
}
}
for(i in temp){
for(rep in 1:6){
subset = subset(TPC, temp == i & Rep == rep)
subset[,1:3] = log(subset[,1:3])
subset[subset == -Inf| subset == Inf] = NaN
for(s in 1:length(sp)){
# png(filename = paste(("../results/TPC/TPC_gr_single_allreps/"),sp[s],"_",i,"_",rep,sep=""), width = 480, height = 480)
plot(time,subset[,s], xlab = "Hour", ylab = "log(OD)",main = paste(sp[s],"_",i,"_",rep,sep="") , pch = 1)
# graphics.off()
}
}
}
################################# fitting the growth model###################################
logistic_model <- function(t, r_max, K, N_0){ # The classic logistic equation
return(N_0 * K * exp(r_max * t)/(K + N_0 * (exp(r_max * t) - 1)))
}
gompertz_model = function(t, r_max, K, N_0, t_lag){ # Modified gompertz growth model (Zwietering 1990)
return(N_0 + (K - N_0) * exp(-exp(r_max * exp(1) * (t_lag - t)/((K - N_0) * log(10)) + 1)))
}
t = seq(time[1],time[length(time)] , 0.1)
TPC$S18[TPC$temp == 28 & (TPC$time > 30 & TPC$time < 50)] # removing irregular measurements
all_r = data.frame()
all_AIC = data.frame()
for(i in temp){
for(rep in 1:6){
subset = subset(TPC, temp == i & Rep == rep)
subset[,1:3] = log(subset[,1:3])
subset[subset == -Inf| subset == Inf] = NaN
N_0_get = apply(subset[1:3], 2, min, na.rm =T) # minimum
K_get = apply(subset[1:3], 2, max, na.rm =T)
slopes = apply(subset[1:3], 2, diff)
slope_max = apply(slopes[-1,], 2, max, na.rm =T)
r = c() ; aic = c()
for(s in 1:length(sp)){
if(s == 1 & i == 28){ subset[subset$time >30 & subset$time < 55,1] = NaN }
# png(filename = paste(("../results/TPC/TPC_gr_fitting_single_allreps/"),sp[s],"_",i,"_",rep,sep=""), width = 480, height = 480)
plot(time,subset[,s], xlab = "Hour", ylab = "log(OD)",
main = paste(sp[s],"_",i,"_",rep,sep="") , pch = 1)
while(any(is.na(subset[,s]))){
subset[which(is.na(subset[,s])),s] = subset[(which(is.na(subset[,s]))+1),s]
}
N_0_start = N_0_get[s]
K_start = K_get[s]
r_max_start = slope_max[s]
t_lag_start = time[which.max(diff(diff(subset[,s])))] - time[1]
if(t_lag_start>40 || t_lag_start == 0){t_lag_start = 10}
sub = data.frame(subset[,s], subset$time)
names(sub) = c("N", "time")
# fitting gompertz
model_fit_gompertz = try(nlsLM(N~gompertz_model(t = time, r_max, K, N_0, t_lag), sub,
start = list(r_max = r_max_start, K =K_start,
N_0 = N_0_start, t_lag = t_lag_start),
control = list(maxiter = 500)),silent = T)
if(class(model_fit_gompertz) != "try-error"){
r_value_gompertz = round(summary(model_fit_gompertz)$coefficients[1], 4)
AIC_value_gompertz = round(AIC(model_fit_gompertz),3)
gr_gompertz = gompertz_model(t, summary(model_fit_gompertz)$coefficients[1],
summary(model_fit_gompertz)$coefficients[2],
summary(model_fit_gompertz)$coefficients[3],
summary(model_fit_gompertz)$coefficients[4])
lines(t, gr_gompertz, col = "blue")
}else{r_value_gompertz = NaN; AIC_value_gompertz = NaN}
# fitting logistic
model_fit_logistic = try(nlsLM(N~logistic_model(t = time, r_max, K, N_0), sub,
start = list(r_max=r_max_start, N_0 = N_0_start, K = K_start),
control = list(maxiter = 500)),silent = T)
if(class(model_fit_logistic) != "try-error"){
r_value_logistic = round(summary(model_fit_logistic)$coefficients[1], 4)
AIC_value_logistic = round(AIC(model_fit_logistic),3)
gr_logistic = logistic_model(t, summary(model_fit_logistic)$coefficients[1],
summary(model_fit_logistic)$coefficients[3],
summary(model_fit_logistic)$coefficients[2])
lines(t, gr_logistic, col = "darkorange")
}else{r_value_logistic = NaN; AIC_value_logistic = NaN}
# }
if(is.nan(AIC_value_gompertz) | AIC_value_logistic - AIC_value_gompertz < -3 & r_value_logistic != 0 |r_value_gompertz > 1.5){
Model = "Logistic"; r_value = r_value_logistic; AIC_value = AIC_value_logistic
}else{Model = "Gompertz"; r_value = r_value_gompertz; AIC_value = AIC_value_gompertz}
text(60, ((max(subset[,s], na.rm = T)+min(subset[,s], na.rm = T))/2),
paste("r=",r_value,"\nModel= ", Model, sep=""))
legend("topleft", c("Gompertz", "Logistic"), col = c("blue", "darkorange"), lty = 1)
# }
# graphics.off()
r = c(r, r_value)
aic = c(aic, AIC_value)
}
all_r = rbind(all_r, r)
all_AIC = rbind(all_AIC, aic)
}
}
# x = all_r # backup
# all_r = x
all_r[all_r==0] = NaN
# all_r[all_AIC>15] = NaN
all_r[all_r>1.5] = NaN
names(all_r) = sp
all_r$temp = sort(rep(temp,6))
all_r$Rep = rep(1:6,6)
all_r$W02[35] = NaN # value too much higher than all other 5 replicates
all_r$W02[23] = NaN # value too much lower than all other 5 replicates
all_r$S18[all_r$S18<0.1] = NaN # Irregular low value comparing with the point plot
mean = data.frame()
sd = data.frame()
for(i in temp){
subset = subset(all_r, temp == i)
mean = rbind(mean, colMeans(subset[,1:3], na.rm = T))
sd = rbind(sd, apply(subset[,1:3], 2, sd, na.rm = T))
}
names(mean) = sp
names(sd) = sp
mean$temp = temp
sd$temp = temp
color = c("darkgreen","blue", "darkorange")
# png(filename = "../results/TPC/Temperature_performances.png", width = 480, height = 480)
plot(1, type="n", xlab="Temperature", ylab = "Growth rate", main = "Temperature Performance",
xlim = c(temp[1],temp[length(temp)]),
ylim =c(min((mean[,1:3]-sd[,1:3]), na.rm = T),
max((mean[,1:3]+sd[,1:3]), na.rm = T)))
for(i in 1:3){
lines(temp,mean[,i], type="b", pch = 1, col = color[i])
suppressWarnings(arrows(x0=temp, y0=mean[,i]-sd[,i], x1=temp, y1=mean[,i]+sd[,i],
code=3, angle=90, lwd=0.6, length = 0.05, col = color[i]))
}
legend("topleft", sp, cex = 1, col = color, pch = 1, lwd = 1)
